name: CI Pipeline

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ›  Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: latest

      - name: ğŸ” Run Biome Linter
        run: |
          echo "::group::Running Biome Linter"
          npm run lint
          echo "::endgroup::"

  test:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "::group::Installing Dependencies"
          npm ci
          echo "::endgroup::"

      - name: ğŸ”„ Generate Prisma Client
        run: |
          echo "::group::Generating Prisma Client"
          npm run prisma:generate
          echo "::endgroup::"

      - name: ğŸ§ª Run Tests
        run: |
          echo "::group::Running Tests"
          npm run test
          echo "::endgroup::"

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "::group::Installing Dependencies"
          npm ci
          echo "::endgroup::"

      - name: ğŸ—ï¸ Build Project
        run: |
          echo "::group::Building Project"
          npm run build
          echo "::endgroup::"

  build-docker-image:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”‘ Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ³ Build Docker Image
        run: |
          echo "::group::Building Docker Image"
          docker build . --file Dockerfile --tag ghcr.io/${{ github.repository }}:${{ github.sha }}
          docker tag ghcr.io/${{ github.repository }}:${{ github.sha }} ghcr.io/${{ github.repository }}:latest
          echo "::endgroup::"

      - name: ğŸ“¤ Push Docker Image
        run: |
          echo "::group::Pushing Docker Image to GHCR"
          docker push ghcr.io/${{ github.repository }}:${{ github.sha }}
          docker push ghcr.io/${{ github.repository }}:latest
          echo "::endgroup::"

  deploy-image-staging:
    runs-on: ubuntu-latest
    needs: build-docker-image
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”‘ Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: ğŸ”‘ Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‚ Copy docker-compose-staging.yml to VPS
        run: |
          echo "::group::ğŸ“‚ Copying docker-compose file to VPS"
          scp -o StrictHostKeyChecking=no ./docker-compose-staging.yml ${{ secrets.SERVER }}:/home/ubuntu/staging/docker-compose-staging.yml
          echo "::endgroup::"

      - name: ğŸš€ Deploy to Staging
        run: |
          echo "================================="
          echo "ğŸš€ Deploying Staging Environment"
          echo "================================="
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -t ${{ secrets.SERVER }} << 'EOF'
          set -e
          echo "ğŸ”‘ Logging in to GHCR inside VPS..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          echo "â›” Stopping existing containers..."
          docker-compose -f /home/ubuntu/staging/docker-compose-staging.yml down || true
          
          echo "â¬‡ï¸ Pulling latest image..."
          docker pull ghcr.io/${{ github.repository }}:latest
          
          echo "ğŸš€ Starting new containers..."
          docker-compose -f /home/ubuntu/staging/docker-compose-staging.yml up -d --force-recreate
          EOF
          echo "âœ… Staging Deployment Completed!"

deploy-image-production:
    runs-on: ubuntu-latest
    needs: deploy-image-staging
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”‘ Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: ğŸ”‘ Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: â›” Stop Staging Containers
        run: |
          echo "::group::â›” Stopping Staging Containers"
          ssh -o StrictHostKeyChecking=no -t ${{ secrets.SERVER }} << 'EOF'
          docker-compose -f /home/ubuntu/staging/docker-compose-staging.yml down || true
          EOF
          echo "::endgroup::"

      - name: ğŸ“‚ Copy docker-compose-production.yml to VPS
        run: |
          echo "::group::ğŸ“‚ Copying docker-compose file to VPS"
          scp -o StrictHostKeyChecking=no ./docker-compose-production.yml ${{ secrets.SERVER }}:/home/ubuntu/production/docker-compose-production.yml
          echo "::endgroup::"

      - name: ğŸš€ Deploy to Production
        run: |
          echo "================================="
          echo "ğŸš€ Deploying Production Environment"
          echo "================================="
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -t ${{ secrets.SERVER }} << 'EOF'
          set -e
          echo "ğŸ”‘ Logging in to GHCR inside VPS..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          echo "â›” Stopping existing production containers..."
          docker-compose -f /home/ubuntu/production/docker-compose-production.yml down || true
          
          echo "â¬‡ï¸ Pulling latest image..."
          docker pull ghcr.io/${{ github.repository }}:latest
          
          echo "ğŸš€ Starting new production containers..."
          docker-compose -f /home/ubuntu/production/docker-compose-production.yml up -d --force-recreate
          EOF
          echo "âœ… Production Deployment Completed!"

